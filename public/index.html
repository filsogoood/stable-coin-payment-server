<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STABLE CUBE Payment</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- 언어 선택 버튼 -->
        <div class="language-selector">
            <button id="langToggle" class="lang-btn" data-lang="ko">
                <span class="lang-current">한국어</span>
                <span class="lang-toggle">A</span>
            </button>
        </div>
        
        <main>
            <!-- 잔액 표시 섹션 (pk 파라미터 있을 때만 표시) -->
            <div id="balanceSection" class="qr-section hidden">
                <h2 data-i18n="wallet_balance">지갑 잔고</h2>
                <div id="balanceInfo" class="balance-display">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- 메인 카드 -->
            <div class="card-grid">
                <div class="card">
                    <h2 data-i18n="app_title">STABLE CUBE Payment</h2>
                    <p id="mainDescription" data-i18n="main_description">QR 코드를 스캔하여 간편하게 결제를 진행하세요</p>
                    <a href="/scan" class="btn btn-primary" id="scanBtn" data-i18n="scan_qr">QR 스캔하기</a>
                </div>
            </div>

            <!-- 상태 메시지 -->
            <div id="status" class="hidden"></div>
        </main>
    </div>

    <!-- Ethers.js v6 라이브러리 -->
    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.min.js";
        window.ethers = ethers;
    </script>

    <script>
        // 다국어 텍스트 정의
        const i18nTexts = {
            ko: {
                app_title: "STABLE CUBE Payment",
                main_description: "QR 코드를 스캔하여 간편하게 결제를 진행하세요",
                scan_qr: "QR 스캔하기",
                wallet_balance: "지갑 잔고",
                wallet_address: "지갑 주소",
                balance: "잔액",
                balance_query_failed: "잔액 조회 실패",
                payment_qr_scan: "결제 QR 스캔하기",
                wallet_info_set: "잔고를 확인하고 결제를 진행하세요.",
                qr_scanner: "QR 스캐너",
                scan_instruction: "QR 코드를 스캔해주세요",
                camera_start: "카메라 시작",
                camera_stop: "카메라 정지",
                payment_processing: "결제 처리 중",
                payment_progress_text: "안전하게 결제를 처리하고 있습니다...",
                payment_complete: "결제 완료",
                new_payment: "새 결제 진행",
                scan_payment_qr: "결제 QR 코드를 스캔해주세요",
                wallet_private_key_found: "개인키를 발견했습니다",
                wallet_private_key_restored: "개인키를 복원했습니다",
                balance_loading: "잔고 조회 중...",
                balance_display_error: "잔고 표시 중 오류가 발생했습니다",
                wallet_info_updated: "지갑 정보가 업데이트되었습니다",
                language_changed: "언어가 변경되었습니다",
                loading: "로딩 중..."
            },
            en: {
                app_title: "STABLE CUBE Payment",
                main_description: "Scan QR code for seamless payment processing",
                scan_qr: "Scan QR Code",
                wallet_balance: "Wallet Balance",
                wallet_address: "Wallet Address",
                balance: "Balance",
                balance_query_failed: "Balance query failed",
                payment_qr_scan: "Scan Payment QR",
                wallet_info_set: "Check your balance and proceed with payment.",
                qr_scanner: "QR Scanner",
                scan_instruction: "Please scan the QR code",
                camera_start: "Start Camera",
                camera_stop: "Stop Camera",
                payment_processing: "Processing Payment",
                payment_progress_text: "Securely processing your payment...",
                payment_complete: "Payment Complete",
                new_payment: "New Payment",
                scan_payment_qr: "Please scan the payment QR code",
                wallet_private_key_found: "Private key found",
                wallet_private_key_restored: "Private key restored",
                balance_loading: "Loading balance...",
                balance_display_error: "Error occurred while displaying balance",
                wallet_info_updated: "Wallet information updated",
                language_changed: "Language changed",
                loading: "Loading..."
            }
        };

        class IndexWalletManager {
            constructor() {
                this.walletPrivateKey = null;
                this.currentLang = this.loadLanguage();
                this.lastBalanceData = null; // 잔액 데이터 저장용
                this.init();
            }

            async init() {
                this.initializeLanguage();
                await this.checkForWalletInfo();
            }

            // 언어 초기화 및 이벤트 설정
            initializeLanguage() {
                // 저장된 언어 적용
                this.applyLanguage(this.currentLang);
                
                // 언어 버튼 이벤트 설정
                const langToggle = document.getElementById('langToggle');
                if (langToggle) {
                    langToggle.addEventListener('click', () => this.toggleLanguage());
                }
                
                // 초기 언어 버튼 상태 설정
                this.updateLanguageButton();
            }

            // 저장된 언어 로드
            loadLanguage() {
                return sessionStorage.getItem('preferred_language') || 'ko';
            }

            // 언어 저장
            saveLanguage(lang) {
                sessionStorage.setItem('preferred_language', lang);
            }

            // 언어 토글
            toggleLanguage() {
                const newLang = this.currentLang === 'ko' ? 'en' : 'ko';
                this.currentLang = newLang;
                this.saveLanguage(newLang);
                
                // 애니메이션 효과
                const langBtn = document.getElementById('langToggle');
                if (langBtn) {
                    langBtn.classList.add('changing');
                    setTimeout(() => {
                        langBtn.classList.remove('changing');
                    }, 600);
                }
                
                // 언어 적용
                this.applyLanguage(newLang);
                this.updateLanguageButton();
            }

            // 언어 적용
            applyLanguage(lang) {
                const texts = i18nTexts[lang];
                if (!texts) return;

                // data-i18n 속성을 가진 모든 요소 업데이트
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (texts[key]) {
                        if (element.tagName === 'A' || element.tagName === 'BUTTON') {
                            element.textContent = texts[key];
                        } else {
                            element.textContent = texts[key];
                        }
                    }
                });

                // 동적 업데이트가 필요한 요소들
                const mainDescription = document.getElementById('mainDescription');
                if (mainDescription && this.walletPrivateKey) {
                    mainDescription.textContent = texts.wallet_info_set;
                }

                const scanBtn = document.getElementById('scanBtn');
                if (scanBtn && this.walletPrivateKey) {
                    scanBtn.textContent = texts.payment_qr_scan;
                }

                // 이미 표시된 잔액 정보가 있다면 다시 렌더링
                const balanceSection = document.getElementById('balanceSection');
                if (balanceSection && !balanceSection.classList.contains('hidden') && this.lastBalanceData) {
                    this.displayBalance(this.lastBalanceData);
                }
                
                // 현재 표시중인 상태 메시지 업데이트 (언어 변경 적용)
                this.updateCurrentStatusMessage();
            }

            // 현재 표시중인 상태 메시지 업데이트 (언어 변경 시)
            updateCurrentStatusMessage() {
                const statusDiv = document.getElementById('status');
                if (!statusDiv || statusDiv.classList.contains('hidden')) return;
                
                // 현재 상태에 따른 적절한 메시지 업데이트
                const texts = i18nTexts[this.currentLang];
                const currentClass = statusDiv.className;
                
                // 특정 상황에 맞는 메시지로 업데이트
                if (this.walletPrivateKey && !this.lastBalanceData) {
                    // 개인키는 있지만 잔액 조회가 안된 상태
                    this.showStatus('balance_loading', 'info');
                } else if (this.walletPrivateKey && this.lastBalanceData) {
                    // 모든 정보가 준비된 상태
                    this.showStatus('wallet_info_updated', 'success');
                }
            }

            // 언어 버튼 업데이트
            updateLanguageButton() {
                const langCurrent = document.querySelector('.lang-current');
                const langToggle = document.querySelector('.lang-toggle');
                
                if (langCurrent && langToggle) {
                    if (this.currentLang === 'ko') {
                        langCurrent.textContent = '한국어';
                        langToggle.textContent = 'A';
                        document.getElementById('langToggle').setAttribute('data-lang', 'ko');
                    } else {
                        langCurrent.textContent = 'English';
                        langToggle.textContent = '한';
                        document.getElementById('langToggle').setAttribute('data-lang', 'en');
                    }
                }
            }

            async checkForWalletInfo() {
                // URL 쿼리 파라미터에서 개인키 확인
                const urlParams = new URLSearchParams(window.location.search);
                const urlPrivateKey = urlParams.get('pk');
                const urlTimestamp = urlParams.get('t');
                
                if (urlPrivateKey) {
                    console.log('첫번째 QR 코드 감지 - 잔액 조회 시작');
                    console.log('개인키:', urlPrivateKey.substring(0, 10) + '...');
                    console.log('타임스탬프:', urlTimestamp ? new Date(parseInt(urlTimestamp)).toLocaleString() : '없음');
                    
                    // 개인키를 sessionStorage에 저장 (새로고침 시에도 유지)
                    sessionStorage.setItem('wallet_private_key', urlPrivateKey);
                    sessionStorage.setItem('wallet_timestamp', urlTimestamp || Date.now().toString());
                    
                    // 개인키 설정
                    this.walletPrivateKey = urlPrivateKey;
                    
                    // URL에서 파라미터 제거 (보안상)
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    // UI 업데이트
                    this.updateUI();
                    
                    // 잔고 조회
                    await this.fetchAndDisplayBalance();
                } else {
                    // URL에 pk가 없으면 sessionStorage에서 확인
                    const storedPrivateKey = sessionStorage.getItem('wallet_private_key');
                    const storedTimestamp = sessionStorage.getItem('wallet_timestamp');
                    
                    if (storedPrivateKey) {
                        console.log('sessionStorage에서 개인키 복원');
                        console.log('개인키:', storedPrivateKey.substring(0, 10) + '...');
                        console.log('타임스탬프:', storedTimestamp ? new Date(parseInt(storedTimestamp)).toLocaleString() : '없음');
                        
                        // 개인키 설정
                        this.walletPrivateKey = storedPrivateKey;
                        
                        // UI 업데이트
                        this.updateUI();
                        
                        // 잔고 조회
                        await this.fetchAndDisplayBalance();
                    }
                }
            }

            updateUI() {
                const texts = i18nTexts[this.currentLang];
                
                // 메인 설명 텍스트 업데이트
                const mainDescription = document.getElementById('mainDescription');
                if (mainDescription) {
                    mainDescription.textContent = texts.wallet_info_set;
                }

                // QR 스캔 버튼 텍스트 업데이트
                const scanBtn = document.getElementById('scanBtn');
                if (scanBtn) {
                    scanBtn.textContent = texts.payment_qr_scan;
                }
            }

            async fetchAndDisplayBalance() {
                if (!this.walletPrivateKey) {
                    console.log('개인키가 없어 잔고를 조회할 수 없습니다.');
                    return;
                }

                try {
                    console.log('서버에 잔고 조회 요청 중...');
                    
                    // 잔고 섹션 표시
                    const balanceSection = document.getElementById('balanceSection');
                    if (balanceSection) {
                        balanceSection.classList.remove('hidden');
                    }

                    const response = await fetch('/api/wallet/balance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            privateKey: this.walletPrivateKey
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('잔고 조회 성공:', result);

                    // 잔고 데이터 저장 및 표시
                    this.lastBalanceData = result.balance;
                    this.displayBalance(result.balance);
                    
                    // 조용한 잔고 조회 완료

                } catch (error) {
                    console.error('잔고 조회 실패:', error);
                    const texts = i18nTexts[this.currentLang];
                    this.showDirectStatus(`${texts.balance_query_failed}: ${error.message}`, 'error');
                    
                    // 잔고 섹션 숨기기
                    const balanceSection = document.getElementById('balanceSection');
                    if (balanceSection) {
                        balanceSection.classList.add('hidden');
                    }
                }
            }

            displayBalance(balance) {
                const balanceInfo = document.getElementById('balanceInfo');
                if (!balanceInfo) return;

                const texts = i18nTexts[this.currentLang];
                
                balanceInfo.innerHTML = `
                    <div class="balance-item">
                        <span class="balance-label">${texts.wallet_address}:</span>
                        <div class="wallet-address-full" onclick="window.open('https://bscscan.com/address/${balance.address}', '_blank')">${balance.address}</div>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">${balance.tokenBalance.symbol} ${texts.balance}:</span>
                        <span class="balance-value">${balance.tokenBalance.formatted} ${balance.tokenBalance.symbol}</span>
                    </div>
                `;
            }

            showStatus(messageKey, type, fallbackMessage = null) {
                const statusDiv = document.getElementById('status');
                if (!statusDiv) return;

                const texts = i18nTexts[this.currentLang];
                // messageKey가 다국어 키인지 확인, 없으면 fallback 또는 원본 메시지 사용
                const message = texts[messageKey] || fallbackMessage || messageKey;
                
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.classList.remove('hidden');

                // 5초 후 자동 숨김
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
            
            // 기존 호환성을 위한 함수 (원본 메시지를 직접 표시)
            showDirectStatus(message, type) {
                const statusDiv = document.getElementById('status');
                if (!statusDiv) return;

                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.classList.remove('hidden');

                // 5초 후 자동 숨김
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // DOM 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', () => {
            new IndexWalletManager();
        });
    </script>
</body>
</html>
