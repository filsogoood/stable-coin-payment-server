<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <title>STABLE CUBE Payment</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* iOS Safari 긴급 수정 */
        html, body {
            background-color: #1a1a1a !important;
            background: #1a1a1a !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 언어 선택 버튼 -->
        <div class="language-selector">
            <button id="langToggle" class="lang-btn" data-lang="ko">
                <span class="lang-current">한국어</span>
                <span class="lang-toggle">A</span>
            </button>
        </div>
        
        <main>
            <!-- 상단 헤더 -->
            <div class="scan-header">
                <!-- 로고 -->
                <div class="scan-logo-section">
                    <img src="stablelogo.png" alt="STABLE CUBE" class="scan-logo">
                </div>
                <!-- 제목 -->
                <div class="scan-title">
                    <h2 data-i18n="qr_scanner">QR 스캐너</h2>
                </div>
            </div>
            
            <div id="mainQRSection" class="qr-section">
                <div id="scannerSection">
                    <!-- QR 스캔 안내 문구 (카메라 바깥으로 이동) -->
                    <div class="scan-instruction-outer">
                        <p class="scan-instruction-text" data-i18n="scan_instruction">QR 코드를 스캔해주세요</p>
                    </div>
                    
                    <div class="video-container">
                        <video id="scanner-video" autoplay muted playsinline></video>
                        <div class="scan-guide">
                            <div class="scan-frame"></div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-2">
                        <button id="startScanBtn" class="btn btn-primary" data-i18n="camera_start">카메라 시작</button>
                        <button id="stopScanBtn" class="btn btn-secondary hidden" data-i18n="camera_stop">카메라 정지</button>
                    </div>
                </div>



                <div id="status" class="hidden"></div>
                

                
                <!-- 결제 진행 중 로딩 표시 -->
                <div id="paymentProcessing" class="qr-section hidden">
                    <h2 data-i18n="payment_processing">결제 처리 중</h2>
                    <div class="text-center">
                        <div class="loading"></div>
                        <p id="paymentProgressText" data-i18n="payment_progress_text">안전하게 결제를 처리하고 있습니다...</p>
                    </div>
                </div>
            </div>

            <div id="resultSection" class="qr-section hidden">
                <h2 data-i18n="payment_complete">결제 완료</h2>
                <div id="resultInfo"></div>
                
                <div class="text-center mt-3">
                    <button id="newScanBtn" class="btn btn-primary" data-i18n="new_payment">새 결제 진행</button>
                </div>
            </div>
        </main>
    </div>

    <!-- QR 스캐너 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    
    <!-- Ethers.js v6 라이브러리 -->
    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.min.js";
        window.ethers = ethers;
    </script>
    
    <!-- 다국어 지원 스크립트 -->
    <script>
        // scan.html용 다국어 텍스트 정의 (전역 노출)
        const scanPageI18n = {
            ko: {
                qr_scanner: "STABLE CUBE SCANNER",
                scan_instruction: "QR 코드를 스캔해주세요",
                camera_start: "카메라 시작",
                camera_stop: "카메라 정지", 

                payment_processing: "결제 처리 중",
                payment_progress_text: "안전하게 결제를 처리하고 있습니다...",
                payment_complete: "결제 완료",
                new_payment: "새 결제 진행",

                scan_payment_qr: "결제 QR 코드를 스캔해주세요",
                
                // 추가 메시지들
                camera_started: "카메라가 시작되었습니다. QR 코드를 스캔해주세요.",
                camera_stopped: "카메라가 정지되었습니다.",
                scanner_init_failed: "스캐너 초기화 실패",
                camera_permission_required: "카메라 권한이 필요합니다. 브라우저 설정에서 카메라 접근을 허용해주세요.",
                qr_detected: "QR 코드 감지! 데이터 처리 중...",
                invalid_qr_code: "유효하지 않은 QR 코드입니다",
                qr_scan_success: "QR 코드를 스캔했습니다",
                processing_payment: "결제를 진행합니다...",
                payment_failed: "결제 실행 실패",
                scanner_reset: "새로운 QR 코드를 스캔할 준비가 되었습니다.",
                wallet_info_scanned: "지갑 정보 QR 코드를 스캔했습니다.",
                payment_info_scanned: "결제 정보 QR 코드를 스캔했습니다. 결제를 진행합니다...",
                purchase_completed: "구매가 완료되었습니다!",
                transaction_hash: "거래 해시",
                remaining_balance_loading: "남은 잔고 조회 중...",
                remaining_balance_title: "남은 잔고",
                remaining_balance_error: "남은 잔고를 조회할 수 없습니다.",
                // 결제 진행 단계 메시지들
                generating_signature: "서명 생성 중...",
                verifying_signature: "서명 검증 및 결제 실행 중...",
                payment_executing: "결제 실행 중...",
                combining_keys: "서버에서 개인키와 결제정보 결합 중...",
                decrypting_data: "서버에서 암호화 데이터 복호화 중..."
            },
            en: {
                qr_scanner: "STABLE CUBE SCANNER",
                scan_instruction: "Please scan the QR code",
                camera_start: "Start Camera",
                camera_stop: "Stop Camera",

                payment_processing: "Processing Payment",
                payment_progress_text: "Securely processing your payment...",
                payment_complete: "Payment Complete",
                new_payment: "New Payment",

                scan_payment_qr: "Please scan the payment QR code",
                
                // 추가 메시지들
                camera_started: "Camera started. Please scan the QR code.",
                camera_stopped: "Camera stopped.",
                scanner_init_failed: "Scanner initialization failed",
                camera_permission_required: "Camera permission is required. Please allow camera access in browser settings.",
                qr_detected: "QR code detected! Processing data...",
                invalid_qr_code: "Invalid QR code",
                qr_scan_success: "QR code scanned successfully",
                processing_payment: "Processing payment...",
                payment_failed: "Payment execution failed",
                scanner_reset: "Ready to scan new QR code.",
                wallet_info_scanned: "Wallet information QR code scanned.",
                payment_info_scanned: "Payment information QR code scanned. Processing payment...",
                purchase_completed: "Purchase completed!",
                transaction_hash: "Transaction Hash",
                remaining_balance_loading: "Loading remaining balance...",
                remaining_balance_title: "Remaining Balance",
                remaining_balance_error: "Unable to retrieve remaining balance.",
                // 결제 진행 단계 메시지들
                generating_signature: "Generating signature...",
                verifying_signature: "Verifying signature and executing payment...",
                payment_executing: "Executing payment...",
                combining_keys: "Combining private key and payment information on server...",
                decrypting_data: "Decrypting encrypted data on server..."
            }
        };

        // 언어 관리 함수들
        function loadScanLanguage() {
            return sessionStorage.getItem('preferred_language') || 'ko';
        }

        function saveScanLanguage(lang) {
            sessionStorage.setItem('preferred_language', lang);
        }

        function applyScanLanguage(lang) {
            const texts = scanPageI18n[lang];
            if (!texts) return;

            // data-i18n 속성을 가진 모든 요소 업데이트
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (texts[key]) {
                    element.textContent = texts[key];
                }
            });

            // 페이지 제목도 업데이트
            document.title = lang === 'ko' ? 'QR 스캔 - STABLE CUBE Payment' : 'QR Scan - STABLE CUBE Payment';
        }

        function updateScanLanguageButton(currentLang) {
            const langCurrent = document.querySelector('.lang-current');
            const langToggle = document.querySelector('.lang-toggle');
            
            if (langCurrent && langToggle) {
                if (currentLang === 'ko') {
                    langCurrent.textContent = '한국어';
                    langToggle.textContent = 'A';
                    document.getElementById('langToggle').setAttribute('data-lang', 'ko');
                } else {
                    langCurrent.textContent = 'English';
                    langToggle.textContent = '한';
                    document.getElementById('langToggle').setAttribute('data-lang', 'en');
                }
            }
        }

        function toggleScanLanguage() {
            const currentLang = loadScanLanguage();
            const newLang = currentLang === 'ko' ? 'en' : 'ko';
            saveScanLanguage(newLang);
            
            // 애니메이션 효과
            const langBtn = document.getElementById('langToggle');
            if (langBtn) {
                langBtn.classList.add('changing');
                setTimeout(() => {
                    langBtn.classList.remove('changing');
                }, 600);
            }
            
            // 언어 적용
            applyScanLanguage(newLang);
            updateScanLanguageButton(newLang);
            
            // PaymentScanner 인스턴스에 언어 변경 알림 및 관련 UI 업데이트
            if (window.paymentScannerInstance) {
                window.paymentScannerInstance.currentLang = newLang;
                
                // 이미 표시된 잔액 정보가 있다면 다시 렌더링
                if (window.paymentScannerInstance.lastBalanceData) {
                    window.paymentScannerInstance.displayBalance(window.paymentScannerInstance.lastBalanceData);
                }
                
                // 현재 표시되고 있는 동적 메시지들 업데이트
                updateScanPageDynamicMessages(newLang);
            }
        }

        // 언어 변경 시 동적 메시지들 업데이트
        function updateScanPageDynamicMessages(lang) {
            const texts = scanPageI18n[lang];
            if (!texts) return;
            
            // 현재 표시중인 상태 메시지 업데이트
            const statusEl = document.getElementById('status');
            if (statusEl && !statusEl.classList.contains('hidden')) {
                const currentMessage = statusEl.textContent;
                
                // 스캔 가이드 메시지 업데이트
                const scanGuide = document.querySelector('.scan-instruction');
                if (scanGuide) {
                    const currentGuideText = scanGuide.textContent;
                    // 기본 스캔 메시지인 경우
                    if (currentGuideText.includes('QR') || currentGuideText.includes('스캔') || currentGuideText.includes('scan')) {
                        // 첫 번째 QR이 완료된 경우와 그렇지 않은 경우 구분
                        if (window.paymentScannerInstance && window.paymentScannerInstance.firstQRScanned) {
                            scanGuide.textContent = texts.scan_payment_qr;
                            scanGuide.style.color = '#FFC107';
                        } else {
                            scanGuide.textContent = texts.scan_instruction;
                            scanGuide.style.color = '';
                        }
                    }
                }
                
                // 일반적인 상태 메시지들 업데이트
                if (currentMessage.includes('카메라') || currentMessage.includes('camera')) {
                    if (currentMessage.includes('시작') || currentMessage.includes('start')) {
                        statusEl.textContent = '카메라가 시작되었습니다. ' + texts.scan_instruction;
                    } else if (currentMessage.includes('정지') || currentMessage.includes('stop')) {
                        statusEl.textContent = lang === 'ko' ? '카메라가 정지되었습니다.' : 'Camera stopped.';
                    }
                } else if (currentMessage.includes('스캔') || currentMessage.includes('scan')) {
                    statusEl.textContent = texts.scan_instruction;
                }
            }
            
            // 결제 완료 섹션의 메시지들도 필요시 업데이트
            const resultSection = document.getElementById('resultSection');
            if (resultSection && !resultSection.classList.contains('hidden')) {
                // 결제 완료 섹션 내의 data-i18n 속성을 가진 요소들 업데이트
                const resultElements = resultSection.querySelectorAll('[data-i18n]');
                resultElements.forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (texts[key]) {
                        element.textContent = texts[key];
                    }
                });
            }
        }

        // 전역으로 노출
        window.scanPageI18n = scanPageI18n;
        window.updateScanPageDynamicMessages = updateScanPageDynamicMessages;

        // 페이지 로드 시 언어 초기화
        document.addEventListener('DOMContentLoaded', () => {
            const currentLang = loadScanLanguage();
            applyScanLanguage(currentLang);
            updateScanLanguageButton(currentLang);
            
            // 언어 버튼 이벤트 설정
            const langToggle = document.getElementById('langToggle');
            if (langToggle) {
                langToggle.addEventListener('click', toggleScanLanguage);
            }
        });
    </script>

    <!-- 페이지 스크립트 -->
    <script src="scan-payment.js"></script>
</body>
</html>
