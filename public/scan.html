<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 코드 스캔 - 가스리스 결제</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>QR 코드 스캔</h1>
            <p>QR 코드를 스캔하여 가스리스 결제를 진행합니다</p>
        </header>

        <main>
            <div class="qr-section">
                <h2>📸 QR 코드 스캐너</h2>
                
                <div id="scannerSection">
                    <div class="video-container">
                        <video id="scanner-video" autoplay muted playsinline></video>
                        <div class="scanner-overlay"></div>
                        <div class="scan-guide">
                            <div class="scan-frame"></div>
                            <div class="scan-instruction">QR 코드를 이 영역에 맞춰주세요</div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-2">
                        <button id="startScanBtn" class="btn btn-primary">카메라 시작</button>
                        <button id="stopScanBtn" class="btn btn-secondary hidden">카메라 정지</button>
                    </div>
                </div>

                <div id="fileUploadSection" class="mt-3">
                    <div class="form-group">
                        <label for="qrFileInput">또는 QR 이미지 파일 업로드:</label>
                        <input type="file" id="qrFileInput" class="form-control" accept="image/*">
                    </div>
                </div>

                <div id="status" class="hidden"></div>
                
                <!-- 디버깅 정보 섹션 -->
                <div id="debugSection" class="qr-section">
                    <h3>🔧 시스템 상태</h3>
                    <div id="debugInfo" class="status info">
                        <div>상태 확인 중...</div>
                    </div>
                    <button id="toggleDebugBtn" class="btn btn-secondary btn-sm">
                        디버깅 정보 숨기기
                    </button>
                </div>
            </div>

            <div id="paymentSection" class="qr-section hidden">
                <h2>💳 결제 정보 확인</h2>
                
                <div id="paymentInfo"></div>
                
                <div class="text-center mt-3">
                    <button id="executePaymentBtn" class="btn btn-success">
                        <span id="paymentText">가스리스 결제 실행</span>
                        <span id="paymentLoading" class="loading hidden"></span>
                    </button>
                    <button id="cancelPaymentBtn" class="btn btn-secondary ml-2">취소</button>
                </div>
            </div>

            <div id="resultSection" class="qr-section hidden">
                <h2>✅ 결제 결과</h2>
                <div id="resultInfo"></div>
                
                <div class="text-center mt-3">
                    <button id="newScanBtn" class="btn btn-primary">새로운 스캔</button>
                </div>
            </div>

            <div class="info-section">
                <h3>💡 사용 방법</h3>
                <ol>
                    <li><strong>카메라 시작:</strong> "카메라 시작" 버튼을 클릭하여 QR 스캐너를 활성화합니다</li>
                    <li><strong>QR 스캔:</strong> 결제 정보가 포함된 QR 코드를 카메라에 비춥니다</li>
                    <li><strong>정보 확인:</strong> 스캔된 결제 정보를 확인합니다</li>
                    <li><strong>결제 실행:</strong> "가스리스 결제 실행" 버튼을 클릭하여 결제를 완료합니다</li>
                </ol>
                
                <div class="status info mt-3">
                    <strong>📱 모바일 최적화:</strong><br>
                    이 페이지는 모바일 기기에서 최적화되어 동작합니다. 카메라 권한을 허용해주세요.<br>
                    <strong>⚠️ 중요:</strong> HTTPS 연결이 필요하며, 최신 브라우저(Chrome, Safari)에서 최적으로 동작합니다.
                </div>
                
                <div class="status warning mt-2">
                    <strong>🔧 문제 해결:</strong><br>
                    카메라가 작동하지 않는 경우:<br>
                    1. 브라우저 설정에서 카메라 권한 확인<br>
                    2. 다른 브라우저로 시도<br>
                    3. 위의 파일 업로드 기능 사용
                </div>
            </div>

            <div class="text-center mt-3">
                <a href="/" class="btn btn-secondary">홈으로 돌아가기</a>
                <a href="/generate" class="btn btn-primary">QR 생성하러 가기</a>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 가스리스 결제 시스템</p>
        </footer>
    </div>

    <!-- QR 스캐너 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    
    <!-- Ethers.js v6 라이브러리 -->
    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";
        window.ethers = ethers;
    </script>
    
    <!-- 페이지 스크립트 -->
    <script src="scan-payment.js"></script>
</body>
</html>
